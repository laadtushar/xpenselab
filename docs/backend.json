{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the FinanceFlow application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user account was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "createdAt"
      ]
    },
    "Income": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Income",
      "type": "object",
      "description": "Represents a single income entry for a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Income entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Income)"
        },
        "amount": {
          "type": "number",
          "description": "The amount of income received."
        },
        "description": {
          "type": "string",
          "description": "Description of the income source."
        },
        "date": {
          "type": "string",
          "description": "Date when the income was received.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "amount",
        "date"
      ]
    },
    "Expense": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Expense",
      "type": "object",
      "description": "Represents a single expense entry for a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Expense entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Expense)"
        },
        "amount": {
          "type": "number",
          "description": "The amount of the expense."
        },
        "description": {
          "type": "string",
          "description": "Description of the expense."
        },
        "categoryId": {
          "type": "string",
          "description": "Reference to Category. (Relationship: Category 1:N Expense)"
        },
        "date": {
          "type": "string",
          "description": "Date when the expense was incurred.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "amount",
        "categoryId",
        "date"
      ]
    },
    "Category": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Category",
      "type": "object",
      "description": "Represents a category for expenses.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Category entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the expense category (e.g., 'Food', 'Rent', 'Transportation')."
        },
        "description": {
          "type": "string",
          "description": "Description of what the category represents."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "Budget": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Budget",
      "type": "object",
      "description": "Represents a user's budget for a specific category and time period.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Budget entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Budget)"
        },
        "categoryId": {
          "type": "string",
          "description": "Reference to Category. (Relationship: Category 1:N Budget)"
        },
        "amount": {
          "type": "number",
          "description": "The budgeted amount for the category."
        },
        "startDate": {
          "type": "string",
          "description": "The starting date for the budget period.",
          "format": "date-time"
        },
        "endDate": {
          "type": "string",
          "description": "The ending date for the budget period.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "categoryId",
        "amount",
        "startDate",
        "endDate"
      ]
    },
    "Group": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Group",
      "type": "object",
      "description": "Represents a group of users for splitting expenses.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Group."
        },
        "name": {
          "type": "string",
          "description": "Name of the group."
        },
        "members": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Array of user IDs who are members of this group."
        },
        "createdBy": {
          "type": "string",
          "description": "User ID of the user who created the group."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of when the group was created."
        }
      },
      "required": [
        "id",
        "name",
        "members",
        "createdBy",
        "createdAt"
      ]
    },
    "SharedExpense": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Shared Expense",
      "type": "object",
      "description": "Represents an expense shared among users in a group.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Shared Expense."
        },
        "groupId": {
          "type": "string",
          "description": "Reference to the Group this expense belongs to."
        },
        "description": {
          "type": "string",
          "description": "Description of the shared expense."
        },
        "amount": {
          "type": "number",
          "description": "Total amount of the expense."
        },
        "paidBy": {
          "type": "string",
          "description": "User ID of the user who paid for the expense."
        },
        "date": {
          "type": "string",
          "format": "date-time",
          "description": "Date when the expense occurred."
        },
        "splits": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "userId": {
                "type": "string"
              },
              "amount": {
                "type": "number"
              }
            },
            "required": [
              "userId",
              "amount"
            ]
          },
          "description": "Details of how the expense is split among members."
        }
      },
      "required": [
        "id",
        "groupId",
        "description",
        "amount",
        "paidBy",
        "date",
        "splits"
      ]
    },
    "Debt": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Debt",
      "type": "object",
      "description": "Represents a debt between two users.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Debt."
        },
        "fromUserId": {
          "type": "string",
          "description": "User ID of the user who owes money."
        },
        "toUserId": {
          "type": "string",
          "description": "User ID of the user who is owed money."
        },
        "amount": {
          "type": "number",
          "description": "The amount of money owed."
        },
        "groupId": {
          "type": "string",
          "description": "Reference to the Group this debt is associated with."
        }
      },
      "required": [
        "id",
        "fromUserId",
        "toUserId",
        "amount",
        "groupId"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile data. Path-based ownership ensures that only the user can access their own profile.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/incomes/{incomeId}",
        "definition": {
          "entityName": "Income",
          "schema": {
            "$ref": "#/backend/entities/Income"
          },
          "description": "Stores income entries for a specific user. Path-based ownership; only the user can access their own income data.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "incomeId",
              "description": "The unique identifier of the income entry."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/expenses/{expenseId}",
        "definition": {
          "entityName": "Expense",
          "schema": {
            "$ref": "#/backend/entities/Expense"
          },
          "description": "Stores expense entries for a specific user. Path-based ownership; only the user can access their own expense data.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "expenseId",
              "description": "The unique identifier of the expense entry."
            }
          ]
        }
      },
      {
        "path": "/categories/{categoryId}",
        "definition": {
          "entityName": "Category",
          "schema": {
            "$ref": "#/backend/entities/Category"
          },
          "description": "Stores global expense categories.",
          "params": [
            {
              "name": "categoryId",
              "description": "The unique identifier of the category."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/budgets/{budgetId}",
        "definition": {
          "entityName": "Budget",
          "schema": {
            "$ref": "#/backend/entities/Budget"
          },
          "description": "Stores budget entries for a specific user. Path-based ownership; only the user can access their own budget data.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "budgetId",
              "description": "The unique identifier of the budget entry."
            }
          ]
        }
      },
      {
        "path": "/groups/{groupId}",
        "definition": {
          "entityName": "Group",
          "schema": {
            "$ref": "#/backend/entities/Group"
          },
          "description": "Stores group information, including members. Accessible by group members.",
          "params": [
            {
              "name": "groupId",
              "description": "The unique identifier of the group."
            }
          ]
        }
      },
      {
        "path": "/groups/{groupId}/sharedExpenses/{sharedExpenseId}",
        "definition": {
          "entityName": "SharedExpense",
          "schema": {
            "$ref": "#/backend/entities/SharedExpense"
          },
          "description": "Stores shared expenses for a group. Accessible by group members.",
          "params": [
            {
              "name": "groupId",
              "description": "The unique identifier of the group."
            },
            {
              "name": "sharedExpenseId",
              "description": "The unique identifier of the shared expense."
            }
          ]
        }
      },
      {
        "path": "/debts/{debtId}",
        "definition": {
          "entityName": "Debt",
          "schema": {
            "$ref": "#/backend/entities/Debt"
          },
          "description": "Stores debt information between two users. Accessible by the two users involved.",
          "params": [
            {
              "name": "debtId",
              "description": "The unique identifier of the debt."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to ensure authorization independence, clarity, and scalability for the FinanceFlow application.  It leverages path-based ownership for user-specific data and avoids `get()` calls in security rules by denormalizing authorization data where necessary. The structure prioritizes structural segregation, grouping data with similar access requirements into separate collections. This approach allows simpler, more maintainable security rules and robust `list` operations. Since the error indicates a potential issue with authentication, the structure also clearly separates user data from other entities, further isolating potential security concerns.\n\n*   **Users:** User data is stored under `/users/{userId}`.  This enables path-based security, where rules can simply check if `request.auth.uid == userId`. No `get()` calls are required to verify ownership.\n*   **Income, Expenses, Budgets:**  These are subcollections under `/users/{userId}`, reflecting the 1:N relationship. This maintains clear ownership and avoids the need for complex authorization logic.\n*   **Categories:** Categories are global (`/categories/{categoryId}`). In a real-world scenario, you might want to allow user-defined categories, which could be stored under the user's document.\n*   **Groups, SharedExpenses, Debts:** These entities support the new split expense feature. Groups are top-level to be referenced by multiple users. Shared expenses are a subcollection of groups. Debts are top-level and can be queried by the users involved."
  }
}