/**
 * @fileoverview Firestore Security Rules for FinanceFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal financial data
 * and shared access control for collaborative features like groups and shared expenses.
 * All data is scoped to the authenticated user, with the exception of group-related data
 * which is accessible to group members.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles.
 * - /users/{userId}/incomes/{incomeId}: Income entries for a user.
 * - /users/{userId}/expenses/{expenseId}: Expense entries for a user.
 * - /users/{userId}/categories/{categoryId}: Custom categories for a user.
 * - /users/{userId}/budgets/{budgetId}: Budget entries for a user.
 * - /groups/{groupId}: Groups of users for shared expenses.
 * - /groups/{groupId}/sharedExpenses/{sharedExpenseId}: Shared expense items for a group.
 * - /debts/{debtId}: Represents debts between users.
 *
 * Key Security Decisions:
 * - Users can only access their own profile and associated financial data.
 * - Group access is controlled by the 'members' list in the Group document.
 * - Listing of debts is allowed for any authenticated user.
 *
 * Denormalization for Authorization:
 * - Group membership is denormalized into the Group document to avoid costly queries.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create) Authenticated user can create their own profile if the userId matches their auth.uid.
     * @allow (get, update, delete) Authenticated user can read, update, and delete their own profile.
     * @deny (create) User cannot create a profile with a different userId.
     * @deny (get, update, delete) User cannot read, update, or delete another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to income entries for a specific user.
     * @path /users/{userId}/incomes/{incomeId}
     * @allow (create) Authenticated user can create income entries under their own user ID.
     * @allow (get, list, update, delete) Authenticated user can read, list, update, and delete their own income entries.
     * @deny (create) User cannot create income entries under another user's ID.
     * @deny (get, list, update, delete) User cannot read, list, update, or delete another user's income entries.
     * @principle Restricts access to a user's own income data.
     */
    match /users/{userId}/incomes/{incomeId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to expense entries for a specific user.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (create) Authenticated user can create expense entries under their own user ID.
     * @allow (get, list, update, delete) Authenticated user can read, list, update, and delete their own expense entries.
     * @deny (create) User cannot create expense entries under another user's ID.
     * @deny (get, list, update, delete) User cannot read, list, update, or delete another user's expense entries.
     * @principle Restricts access to a user's own expense data.
     */
    match /users/{userId}/expenses/{expenseId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to user-specific expense categories.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create) Authenticated user can create categories under their own user ID.
     * @allow (get, list, update, delete) Authenticated user can read, list, update, and delete their own categories.
     * @deny (create) User cannot create categories under another user's ID.
     * @deny (get, list, update, delete) User cannot read, list, update, or delete another user's categories.
     * @principle Restricts access to a user's own category data.
     */
    match /users/{userId}/categories/{categoryId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to budget entries for a specific user.
     * @path /users/{userId}/budgets/{budgetId}
     * @allow (create) Authenticated user can create budget entries under their own user ID.
     * @allow (get, list, update, delete) Authenticated user can read, list, update, and delete their own budget entries.
     * @deny (create) User cannot create budget entries under another user's ID.
     * @deny (get, list, update, delete) User cannot read, list, update, or delete another user's budget entries.
     * @principle Restricts access to a user's own budget data.
     */
    match /users/{userId}/budgets/{budgetId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to group information, including members.
     * @path /groups/{groupId}
     * @allow (create) Authenticated user can create a group.
     * @allow (get, list) Any authenticated user can read and list groups if they are a member
     * @allow (update, delete) Only the group creator can update or delete the group.
     * @deny (create) Unauthenticated users cannot create a group.
     * @deny (update, delete) Non-group creators cannot update or delete groups.
     * @principle Manages access to shared group data.
     */
    match /groups/{groupId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isGroupMember(groupId) {
        return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
      }
      function isGroupCreator(groupId) {
          return isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid;
      }

      allow get: if isSignedIn() && isGroupMember(groupId);
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isGroupCreator(groupId);
      allow delete: if isSignedIn() && isGroupCreator(groupId);
    }

    /**
     * @description Controls access to shared expense items for a group.
     * @path /groups/{groupId}/sharedExpenses/{sharedExpenseId}
     * @allow (create) Authenticated user can create shared expenses if they are a group member.
     * @allow (get, list) Any authenticated user who is a group member can read/list.
     * @allow (update, delete) Only group members can update or delete shared expenses.
     * @deny (create) Non-group members cannot create shared expenses.
     *  @principle Manages access to shared expense data within a group.
     */
    match /groups/{groupId}/sharedExpenses/{sharedExpenseId} {
      function isSignedIn() {
        return request.auth != null;
      }
       function isGroupMember(groupId) {
        return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
      }
      allow get: if isSignedIn() && isGroupMember(groupId);
      allow list: if isSignedIn() && isGroupMember(groupId);
      allow create: if isSignedIn() && isGroupMember(groupId);
      allow update: if isSignedIn() && isGroupMember(groupId);
      allow delete: if isSignedIn() && isGroupMember(groupId);
    }

    /**
     * @description Controls access to debt information between two users.
     * @path /debts/{debtId}
     * @allow (get) Any authenticated user can get debt.
     * @allow (list) Any authenticated user can list debts.
     * @allow (create) Authenticated user can create a debt.
     * @allow (update, delete) No one can update or delete debts.
     * @principle Manages access to debt data.
     */
    match /debts/{debtId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}