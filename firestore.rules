/**
 * @fileoverview Firestore Security Rules for FinanceFlow.
 *
 * Core Philosophy: This ruleset enforces a strict user-ownership model for personal financial data,
 * and a shared-access model for collaborative group expenses.  It prioritizes security and
 * maintainability.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data.
 * - /users/{userId}/incomes/{incomeId}: Stores income entries for a specific user.
 * - /users/{userId}/expenses/{expenseId}: Stores expense entries for a specific user.
 * - /users/{userId}/categories/{categoryId}: Stores user-specific expense categories.
 * - /users/{userId}/budgets/{budgetId}: Stores budget entries for a specific user.
 * - /groups/{groupId}: Stores group information, including members (array of user IDs).
 * - /groups/{groupId}/sharedExpenses/{sharedExpenseId}: Stores shared expenses for a group.
 * - /debts/{debtId}: Stores debt information between two users.
 *
 * Key Security Decisions:
 * - User data (incomes, expenses, etc.) is strictly controlled by the owning user.
 * - Groups and SharedExpenses are accessible only to group members.  The `members` array on the
 *   Group document is the source of truth for group membership.
 * - Listing of user documents is restricted to the owner.
 *
 * Denormalization for Authorization:
 * - Group membership is denormalized into the `members` array on the `/groups/{groupId}` document.
 *   This avoids costly `get()` calls to a separate membership collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @returns {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user ID matches the authenticated user's ID, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the existing owner of the resource.
     *              This function also ensures that the resource exists before proceeding.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user ID matches and resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user is a member of the group.
     * @param {array} members - An array of user IDs who are members of the group.
     * @returns {boolean} True if the authenticated user's ID is in the members array, false otherwise.
     */
    function isGroupMember(members) {
      return isSignedIn() && request.auth.uid in members;
    }

    /**
     * @description Rule for the /users/{userId} collection.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) - If the authenticated user's ID matches the userId in the path.
     * @deny (create) - If the authenticated user's ID does not match the userId in the path.
     * @allow (get, update, delete) - If the authenticated user's ID matches the userId in the path.
     * @deny (get, update, delete) - If the authenticated user's ID does not match the userId in the path.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/incomes/{incomeId} collection.
     * @path /databases/{database}/documents/users/{userId}/incomes/{incomeId}
     * @allow (create, get, update, delete, list) - If the authenticated user's ID matches the userId in the path.
     * @deny (create, get, update, delete, list) - If the authenticated user's ID does not match the userId in the path.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/incomes/{incomeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/expenses/{expenseId} collection.
     * @path /databases/{database}/documents/users/{userId}/expenses/{expenseId}
     * @allow (create, get, update, delete, list) - If the authenticated user's ID matches the userId in the path.
     * @deny (create, get, update, delete, list) - If the authenticated user's ID does not match the userId in the path.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/expenses/{expenseId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/categories/{categoryId} collection.
     * @path /databases/{database}/documents/users/{userId}/categories/{categoryId}
     * @allow (create, get, update, delete, list) - If the authenticated user's ID matches the userId in the path.
     * @deny (create, get, update, delete, list) - If the authenticated user's ID does not match the userId in the path.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/categories/{categoryId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/budgets/{budgetId} collection.
     * @path /databases/{database}/documents/users/{userId}/budgets/{budgetId}
     * @allow (create, get, update, delete, list) - If the authenticated user's ID matches the userId in the path.
     * @deny (create, get, update, delete, list) - If the authenticated user's ID does not match the userId in the path.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/budgets/{budgetId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /groups/{groupId} collection.
     * @path /databases/{database}/documents/groups/{groupId}
     * @allow (get, list) - If the authenticated user is a member of the group.
     * @allow (create) - If the authenticated user creates it.
     * @allow (update, delete) - If the authenticated user is the creator of the group.
     * @deny (get, list) - If the authenticated user is not a member of the group.
     * @deny (create) - If the authenticated user does not create it.
     * @deny (update, delete) - If the authenticated user is not the creator of the group.
     * @principle Enforces group membership for access to group information.
     */
    match /groups/{groupId} {
      allow get: if isGroupMember(resource.data.members);
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isSignedIn() && resource.data.createdBy == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
    }

    /**
     * @description Rule for the /groups/{groupId}/sharedExpenses/{sharedExpenseId} collection.
     * @path /databases/{database}/documents/groups/{groupId}/sharedExpenses/{sharedExpenseId}
     * @allow (create, get, update, delete, list) - If the authenticated user is a member of the group.
     * @deny (create, get, update, delete, list) - If the authenticated user is not a member of the group.
     * @principle Enforces group membership for access to shared expenses.
     */
    match /groups/{groupId}/sharedExpenses/{sharedExpenseId} {
      allow get: if isGroupMember(get(/databases/$(database)/documents/groups/$(groupId)).data.members);
      allow list: if isGroupMember(get(/databases/$(database)/documents/groups/$(groupId)).data.members);
      allow create: if isGroupMember(get(/databases/$(database)/documents/groups/$(groupId)).data.members);
      allow update: if isGroupMember(get(/databases/$(database)/documents/groups/$(groupId)).data.members);
      allow delete: if isGroupMember(get(/databases/$(database)/documents/groups/$(groupId)).data.members);
    }

    /**
     * @description Rule for the /debts/{debtId} collection.
     * @path /databases/{database}/documents/debts/{debtId}
     * @allow (get) - If the authenticated user is either the 'fromUserId' or the 'toUserId' in the debt.
     * @allow (list) - None.
     * @allow (create) - If the authenticated user is the 'fromUserId'.
     * @allow (update, delete) - None. Debts should not be updated or deleted directly.
     * @deny (get) - If the authenticated user is not either the 'fromUserId' or the 'toUserId' in the debt.
     * @deny (list) - Always.
     * @deny (create) - If the authenticated user is not the 'fromUserId'.
     * @deny (update, delete) - Always.
     * @principle Enforces that only the involved users can read debt information and that debts can only be created, not directly modified or deleted.
     */
    match /debts/{debtId} {
      allow get: if isSignedIn() && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.fromUserId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }
  }
}