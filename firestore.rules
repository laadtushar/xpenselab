/**
 * @fileoverview Firestore Security Rules for FinanceFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal financial data
 * and shared access control for collaborative group expenses. Only authenticated
 * users can access data. User data is isolated by UID.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.
 * - /users/{userId}/incomes: Stores income entries for a user.
 * - /users/{userId}/expenses: Stores expense entries for a user.
 * - /users/{userId}/categories: Stores user-defined categories.
 * - /users/{userId}/budgets: Stores budget entries for a user.
 * - /groups: Stores group information for shared expenses.
 * - /groups/{groupId}/sharedExpenses: Stores shared expenses for a group.
 * - /debts: Stores debt information between two users.
 *
 * Key Security Decisions:
 * - Users can only read/write their own profile data.
 * - Users can only read/write their own income, expense, category, and budget data.
 * - Group data is accessible to group members.
 * - Debts can only be created with valid user IDs.
 * - Listing of `/users` is denied.
 *
 * Denormalization for Authorization:
 *  - User IDs are included in income, expense, category, budget, group, shared expense, and debt documents
 *    to allow for simple ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure the /users/{userId} collection.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) Authenticated user can create their own user document.
     * @deny (create) Creation fails if the userId does not match the authenticated user's ID.
     * @allow (get, update, delete) Authenticated user can read/write their own user document.
     * @deny (get, update, delete) Read/write fails if the userId does not match the authenticated user's ID.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow create: if isSignedIn() && request.auth.uid == userId;
      allow get, update, delete: if isOwner(userId);
      allow list: if false;
    }

    /**
     * @description Secure the /users/{userId}/incomes collection.
     * @path /databases/{database}/documents/users/{userId}/incomes
     * @allow (create) Authenticated user can create income documents under their user ID.
     * @deny (create) Creation fails if the userId does not match the authenticated user's ID.
     * @allow (get, list, update, delete) Authenticated user can read/write their own income documents.
     * @deny (get, list, update, delete) Read/write fails if the userId does not match the authenticated user's ID.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/incomes/{incomeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow create: if isOwner(userId);
      allow get, list, update, delete: if isOwner(userId);
    }

    /**
     * @description Secure the /users/{userId}/expenses collection.
     * @path /databases/{database}/documents/users/{userId}/expenses
     * @allow (create) Authenticated user can create expense documents under their user ID.
     * @deny (create) Creation fails if the userId does not match the authenticated user's ID.
     * @allow (get, list, update, delete) Authenticated user can read/write their own expense documents.
     * @deny (get, list, update, delete) Read/write fails if the userId does not match the authenticated user's ID.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/expenses/{expenseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow create: if isOwner(userId);
      allow get, list, update, delete: if isOwner(userId);
    }

    /**
     * @description Secure the /users/{userId}/categories collection.
     * @path /databases/{database}/documents/users/{userId}/categories
     * @allow (create) Authenticated user can create category documents under their user ID.
     * @deny (create) Creation fails if the userId does not match the authenticated user's ID.
     * @allow (get, list, update, delete) Authenticated user can read/write their own category documents.
     * @deny (get, list, update, delete) Read/write fails if the userId does not match the authenticated user's ID.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/categories/{categoryId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow create: if isOwner(userId);
      allow get, list, update, delete: if isOwner(userId);
    }

    /**
     * @description Secure the /users/{userId}/budgets collection.
     * @path /databases/{database}/documents/users/{userId}/budgets
     * @allow (create) Authenticated user can create budget documents under their user ID.
     * @deny (create) Creation fails if the userId does not match the authenticated user's ID.
     * @allow (get, list, update, delete) Authenticated user can read/write their own budget documents.
     * @deny (get, list, update, delete) Read/write fails if the userId does not match the authenticated user's ID.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/budgets/{budgetId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow create: if isOwner(userId);
      allow get, list, update, delete: if isOwner(userId);
    }

    /**
     * @description Secure the /groups collection.
     * @path /databases/{database}/documents/groups
     * @allow (create) Authenticated user can create a group, and is automatically a member.
     * @deny (create) Creation fails if the createdBy does not match the authenticated user's ID.
     * @allow (get, list) Members of the group can read the group data.
     * @allow (update, delete) Only the creator can update/delete the group.
     * @principle Shared Access (Closed Collaborators).
     */
    match /groups/{groupId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isMember(groupId) {
        return isSignedIn() && resource.data.members.hasAny([request.auth.uid]);
      }

      function isOwner(createdBy) {
        return isSignedIn() && request.auth.uid == createdBy;
      }

      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid && request.resource.data.members.hasOnly([request.auth.uid]);
      allow get, list: if isMember(groupId);
      allow update, delete: if isOwner(resource.data.createdBy);
    }

    /**
     * @description Secure the /groups/{groupId}/sharedExpenses collection.
     * @path /databases/{database}/documents/groups/{groupId}/sharedExpenses
     * @allow (create) Members of the group can create shared expenses.
     * @deny (create) Creation fails if the groupId does not match.
     * @allow (get, list, update, delete) Members of the group can read/write shared expenses.
     * @deny (get, list, update, delete) Fails if the user is not a member.
     * @principle Shared Access (Closed Collaborators).
     */
    match /groups/{groupId}/sharedExpenses/{sharedExpenseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isMember(groupId) {
        return isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.members.hasAny([request.auth.uid]);
      }

      allow create: if isMember(groupId);
      allow get, list, update, delete: if isMember(groupId);
    }

    /**
     * @description Secure the /debts collection.
     * @path /databases/{database}/documents/debts
     * @allow (create) Authenticated user can create a debt.
     * @deny (create) Creation fails if the userId does not match the authenticated user's ID.
     * @allow (get, list) Only the involved users can read the debt data.
     * @allow (update, delete) No updates or deletes are allowed.
     */
    match /debts/{debtId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isRelatedUser(fromUserId, toUserId) {
            return isSignedIn() && (request.auth.uid == fromUserId || request.auth.uid == toUserId);
        }

        allow create: if isSignedIn() && (request.resource.data.fromUserId == request.auth.uid || request.resource.data.toUserId == request.auth.uid);
        allow get, list: if isSignedIn() && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
        allow update, delete: if false;
    }
  }
}