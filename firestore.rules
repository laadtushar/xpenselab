/**
 * @fileoverview Firestore Security Rules for FinanceFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal financial data
 * (incomes, expenses, categories, budgets). Users can only access and modify their own data.
 * Groups and shared expenses enable collaborative expense tracking.  Debts are tracked individually.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.
 * - /users/{userId}/incomes/{incomeId}: Incomes for a specific user.
 * - /users/{userId}/expenses/{expenseId}: Expenses for a specific user.
 * - /users/{userId}/categories/{categoryId}: User-defined categories.
 * - /users/{userId}/budgets/{budgetId}: User budgets.
 * - /groups/{groupId}: Groups for shared expenses.
 * - /groups/{groupId}/sharedExpenses/{expenseId}: Expenses shared within a group.
 * - /debts/{debtId}: Debts between users.
 *
 * Key Security Decisions:
 * - Users can only read/write their own income, expense, category, and budget data.
 * - Listing all users is disallowed.
 * - Groups are shared documents, with access controlled by the 'members' list.
 * - Debts can only be created, updated, or deleted by either the debtor or creditor.
 *
 * Denormalization for Authorization:
 * - The 'userId' field is present in Income, Expense, Category, and Budget documents
 *   to enforce user-ownership at the document level.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rule for the root of the database.  Does nothing.
     * @path /
     * @allow (get) Authenticated user can access.
     * @deny (create) No one can create a document at the root.
     * @principle This prevents accidental writes to the database root.
     */
    match /{document=**} {
      allow read: if false;
      allow write: if false;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Allows reading and creating user profile data.
     * @path /users/{userId}
     * @allow (get) Any signed-in user can read any user document.
     * @allow (create) A user can create their own user document.
     * @deny (update) A user cannot update the ID of the owner to a different ID.
     * @deny (delete) A user cannot delete other user documents.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if false;
    }

    /**
     * @description Allows a user to manage their own income entries.
     * @path /users/{userId}/incomes/{incomeId}
     * @allow (get) Owner can get.
     * @allow (list) Owner can list.
     * @allow (create) Owner can create.
     * @deny (update) A user cannot update the ID of the owner to a different ID.
     * @deny (delete) A user cannot delete other user documents.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/incomes/{incomeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows a user to manage their own expense entries.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (get) Owner can get.
     * @allow (list) Owner can list.
     * @allow (create) Owner can create.
     * @deny (update) A user cannot update the ID of the owner to a different ID.
     * @deny (delete) A user cannot delete other user documents.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/expenses/{expenseId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows a user to manage their own expense categories.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (get) Owner can get.
     * @allow (list) Owner can list.
     * @allow (create) Owner can create.
     * @deny (update) A user cannot update the ID of the owner to a different ID.
     * @deny (delete) A user cannot delete other user documents.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/categories/{categoryId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows a user to manage their own budget entries.
     * @path /users/{userId}/budgets/{budgetId}
     * @allow (get) Owner can get.
     * @allow (list) Owner can list.
     * @allow (create) Owner can create.
     * @deny (update) A user cannot update the ID of the owner to a different ID.
     * @deny (delete) A user cannot delete other user documents.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/budgets/{budgetId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    function isGroupMember(groupId) {
      return get(/databases/$(database)/documents/groups/$(groupId)).data.members.hasAny([request.auth.uid]);
    }

    function isGroupAdmin(groupId) {
        return get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid;
    }


    /**
     * @description Allows group members to manage group information.
     * @path /groups/{groupId}
     * @allow (get) Group members can read.
     * @allow (list) No listing allowed.
     * @allow (create) Only group admin can create.
     * @deny (update) A user cannot update the members list unless they are the admin.
     * @deny (delete) Only group admin can delete.
     * @principle Enforces membership for reads and admin for writes.
     */
    match /groups/{groupId} {
      allow get: if isGroupMember(groupId);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isGroupAdmin(groupId) && resource != null;
      allow delete: if isGroupAdmin(groupId) && resource != null;
    }

    /**
     * @description Allows group members to manage shared expenses within a group.
     * @path /groups/{groupId}/sharedExpenses/{expenseId}
     * @allow (get) Group members can read.
     * @allow (list) Group members can list.
     * @allow (create) Group members can create.
     * @deny (update) Only the user who paid can update.
     * @deny (delete) Only the user who paid can delete.
     * @principle Enforces membership for reads and ownership for writes.
     */
    match /groups/{groupId}/sharedExpenses/{expenseId} {
      allow get: if isGroupMember(groupId);
      allow list: if isGroupMember(groupId);
      allow create: if isGroupMember(groupId);
      allow update: if get(/databases/$(database)/documents/groups/$(groupId)).data.members.hasAny([request.auth.uid]) && resource != null && request.auth.uid == resource.data.paidBy;
      allow delete: if get(/databases/$(database)/documents/groups/$(groupId)).data.members.hasAny([request.auth.uid]) && resource != null && request.auth.uid == resource.data.paidBy;
    }

    /**
     * @description Allows managing debts between users.
     * @path /debts/{debtId}
     * @allow (get) Any signed-in user can read.
     * @allow (list) Not supported.
     * @allow (create) Only the involved users.
     * @deny (update) Only the involved users can update.
     * @deny (delete) Only the involved users can delete.
     */
    match /debts/{debtId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn() && (request.resource.data.fromUserId == request.auth.uid || request.resource.data.toUserId == request.auth.uid) && request.resource.data.createdBy == request.auth.uid;
      allow update: if isSignedIn() && resource != null && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
      allow delete: if isSignedIn() && resource != null && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
    }
  }
}