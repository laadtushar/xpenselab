/**
 * @fileoverview Firestore Security Rules for FinanceFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal financial data
 * and shared access control for collaborative features like groups and shared expenses.
 * Only authenticated users can access their own data, and shared resources
 * are accessible only to authorized members.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles.
 * - /users/{userId}/incomes/{incomeId}: Income entries for a user.
 * - /users/{userId}/expenses/{expenseId}: Expense entries for a user.
 * - /users/{userId}/categories/{categoryId}: Categories created by a user.
 * - /users/{userId}/budgets/{budgetId}: Budgets defined by a user.
 * - /groups/{groupId}: Information about groups for shared expenses.
 * - /groups/{groupId}/sharedExpenses/{expenseId}: Shared expenses within a group.
 * - /debts/{debtId}: Records of debts between users.
 *
 * Key Security Decisions:
 * - User data is strictly private and accessible only to the authenticated user.
 * - Group data is accessible to group members.
 * - Listing of user documents is disallowed for privacy.
 * - All write operations require authentication and proper authorization.
 *
 * Denormalization for Authorization:
 * - User-specific data (incomes, expenses, categories, budgets) relies on the `userId` field within the document
 *   to match the `userId` in the path.
 * - Group membership is determined by the `members` array in the `/groups/{groupId}` document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to user profile data.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create their own profile.
     * @deny (create) User with UID 'user123' cannot create a profile for 'user456'.
     * @allow (get) User with UID 'user123' can read their own profile.
     * @deny (get) User with UID 'user123' cannot read the profile of 'user456'.
     * @allow (update) User with UID 'user123' can update their own profile.
     * @deny (update) User with UID 'user123' cannot update the profile of 'user456'.
     * @allow (delete) User with UID 'user123' can delete their own profile.
     * @deny (delete) User with UID 'user123' cannot delete the profile of 'user456'.
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Disallow listing all user documents for privacy.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows access to income entries for a specific user.
     * @path /users/{userId}/incomes/{incomeId}
     * @allow (create) User with UID 'user123' can create an income entry for themselves.
     * @deny (create) User with UID 'user123' cannot create an income entry for 'user456'.
     * @allow (get) User with UID 'user123' can read their own income entry.
     * @deny (get) User with UID 'user123' cannot read the income entry of 'user456'.
     * @allow (update) User with UID 'user123' can update their own income entry.
     * @deny (update) User with UID 'user123' cannot update the income entry of 'user456'.
     * @allow (delete) User with UID 'user123' can delete their own income entry.
     * @deny (delete) User with UID 'user123' cannot delete the income entry of 'user456'.
     * @principle Enforces document ownership for all operations on income entries.
     */
    match /users/{userId}/incomes/{incomeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows access to expense entries for a specific user.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (create) User with UID 'user123' can create an expense entry for themselves.
     * @deny (create) User with UID 'user123' cannot create an expense entry for 'user456'.
     * @allow (get) User with UID 'user123' can read their own expense entry.
     * @deny (get) User with UID 'user123' cannot read the expense entry of 'user456'.
     * @allow (update) User with UID 'user123' can update their own expense entry.
     * @deny (update) User with UID 'user123' cannot update the expense entry of 'user456'.
     * @allow (delete) User with UID 'user123' can delete their own expense entry.
     * @deny (delete) User with UID 'user123' cannot delete the expense entry of 'user456'.
     * @principle Enforces document ownership for all operations on expense entries.
     */
    match /users/{userId}/expenses/{expenseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows access to categories for a specific user.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create) User with UID 'user123' can create a category for themselves.
     * @deny (create) User with UID 'user123' cannot create a category for 'user456'.
     * @allow (get) User with UID 'user123' can read their own category.
     * @deny (get) User with UID 'user123' cannot read the category of 'user456'.
     * @allow (update) User with UID 'user123' can update their own category.
     * @deny (update) User with UID 'user123' cannot update the category of 'user456'.
     * @allow (delete) User with UID 'user123' can delete their own category.
     * @deny (delete) User with UID 'user123' cannot delete the category of 'user456'.
     * @principle Enforces document ownership for all operations on categories.
     */
    match /users/{userId}/categories/{categoryId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows access to budgets for a specific user.
     * @path /users/{userId}/budgets/{budgetId}
     * @allow (create) User with UID 'user123' can create a budget for themselves.
     * @deny (create) User with UID 'user123' cannot create a budget for 'user456'.
     * @allow (get) User with UID 'user123' can read their own budget.
     * @deny (get) User with UID 'user123' cannot read the budget of 'user456'.
     * @allow (update) User with UID 'user123' can update their own budget.
     * @deny (update) User with UID 'user123' cannot update the budget of 'user456'.
     * @allow (delete) User with UID 'user123' can delete their own budget.
     * @deny (delete) User with UID 'user123' cannot delete the budget of 'user456'.
     * @principle Enforces document ownership for all operations on budgets.
     */
    match /users/{userId}/budgets/{budgetId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows access to group information for members of the group.
     * @path /groups/{groupId}
     * @allow (create) User with UID 'user123' can create a group where they are a member.
     * @deny (create) User with UID 'user132' cannot create a group where they are not a member.
     * @allow (get) User with UID 'user123' can read a group if they are a member.
     * @deny (get) User with UID 'user123' cannot read a group if they are not a member.
     * @allow (update) User with UID 'user123' can update a group if they are a member.
     * @deny (update) User with UID 'user123' cannot update a group if they are not a member.
     * @allow (delete) User with UID 'user123' can delete a group if they are the creator.
     * @deny (delete) User with UID 'user123' cannot delete a group if they are not the creator.
     * @principle Enforces shared access control based on group membership.
     */
    match /groups/{groupId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isMember(groupId) {
          return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
      }
      
      allow get: if isSignedIn() && isMember(groupId);
      allow list: if false; // Listing groups is not permitted
      allow create: if isSignedIn() && request.resource.data.members.hasAny([request.auth.uid]);
      allow update: if isSignedIn() && isMember(groupId);
      allow delete: if isSignedIn() && resource != null && resource.data.createdBy == request.auth.uid;
    }

    /**
     * @description Allows access to shared expenses for members of a group.
     * @path /groups/{groupId}/sharedExpenses/{expenseId}
     * @allow (create) User with UID 'user123' can create a shared expense in a group they are a member of.
     * @deny (create) User with UID 'user123' cannot create a shared expense in a group they are not a member of.
     * @allow (get) User with UID 'user123' can read a shared expense if they are a member of the group.
     * @deny (get) User with UID 'user123' cannot read a shared expense if they are not a member of the group.
     * @allow (update) User with UID 'user123' can update a shared expense if they are a member of the group.
     * @deny (update) User with UID 'user123' cannot update a shared expense if they are not a member of the group.
     * @allow (delete) User with UID 'user123' can delete a shared expense if they are a member of the group.
     * @deny (delete) User with UID 'user123' cannot delete a shared expense if they are not a member of the group.
     * @principle Enforces shared access control based on group membership.
     */
    match /groups/{groupId}/sharedExpenses/{expenseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isMember(groupId) {
          return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
      }
      
      allow get: if isSignedIn() && isMember(groupId);
      allow list: if false;
      allow create: if isSignedIn() && isMember(groupId);
      allow update: if isSignedIn() && isMember(groupId);
      allow delete: if isSignedIn() && isMember(groupId);
    }

    /**
     * @description Allows access to debt information between two users.
     * @path /debts/{debtId}
     * @allow (create) User with UID 'user123' can create a debt record.
     * @deny (create) User with UID 'user132' cannot create a debt record.
     * @allow (get) User with UID 'user123' can read a debt record if they are involved.
     * @deny (get) User with UID 'user123' cannot read a debt record if they are not involved.
     * @allow (update) User with UID 'user123' can update a debt record if they are involved.
     * @deny (update) User with UID 'user123' cannot update a debt record if they are not involved.
     * @allow (delete) User with UID 'user123' can delete a debt record if they are the creator.
     * @deny (delete) User with UID 'user123' cannot delete a debt record if they are not the creator.
     * @principle Enforces access control based on debt relationship.
     */
    match /debts/{debtId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isDebtorOrCreditor(debtId) {
          return isSignedIn() && (request.auth.uid == get(/databases/$(database)/documents/debts/$(debtId)).data.fromUserId || request.auth.uid == get(/databases/$(database)/documents/debts/$(debtId)).data.toUserId);
      }

      function isDebtCreator(debtId) {
          return isSignedIn() && request.auth.uid == get(/databases/$(database)/documents/debts/$(debtId)).data.createdBy;
      }

      allow get: if isSignedIn() && isDebtorOrCreditor(debtId);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isSignedIn() && isDebtorOrCreditor(debtId);
      allow delete: if isSignedIn() && isDebtCreator(debtId);
    }
  }
}