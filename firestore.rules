/**
 * @fileoverview Firestore Security Rules for FinanceFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal financial data
 * and shared access for collaborative group expenses.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only to the owning user.
 * - /users/{userId}/incomes: Income entries, accessible only to the owning user.
 * - /users/{userId}/expenses: Expense entries, accessible only to the owning user.
 * - /users/{userId}/categories: User-defined categories, accessible only to the owning user.
 * - /users/{userId}/budgets: User budgets, accessible only to the owning user.
 * - /groups/{groupId}: Group information for shared expenses. Members have read access; creator has write access.
 * - /groups/{groupId}/sharedExpenses: Shared expense entries, accessible to group members.
 * - /debts: Debt information between users. Accessible to involved users and the creator.
 *
 * Key Security Decisions:
 * - Users can only access their own data under the /users/{userId} collection.
 * - Group data under /groups/{groupId} is shared among group members.
 * - Listing of all users is disallowed for privacy.
 *
 * Denormalization for Authorization:
 *  - The `Income`, `Expense`, `Category`, and `Budget` entities require the `userId` field
 *  to match the path `/users/{userId}`. This is enforced on `create` and immutability is enforced on `update`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create a profile with id 'user123'.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { email: 'test@example.com', createdAt: '2024-01-01T00:00:00Z' } } }
     * @allow (get) - User with UID 'user123' can read their profile data.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (update) - User with UID 'user123' can update their profile data.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { email: 'newemail@example.com', createdAt: '2024-01-01T00:00:00Z' } } }
     * @allow (delete) - User with UID 'user123' can delete their profile.
     *   Request: { auth: { uid: 'user123' } }
     * @deny (create) - User with UID 'user456' cannot create a profile with id 'user123'.
     *   Request: { auth: { uid: 'user456' }, resource: { data: { email: 'test@example.com', createdAt: '2024-01-01T00:00:00Z' } } }
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows users to read and write their own income entries.
     * @path /users/{userId}/incomes
     * @allow (create) - User with UID 'user123' can create an income entry under /users/user123/incomes.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { userId: 'user123', amount: 1000, date: '2024-01-15', category: 'Salary' } } }
     * @allow (get) - User with UID 'user123' can read an income entry under /users/user123/incomes.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (list) - User with UID 'user123' can list their income entries.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (update) - User with UID 'user123' can update their income entry under /users/user123/incomes.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { userId: 'user123', amount: 1200, date: '2024-01-15', category: 'Salary' } } }
     * @allow (delete) - User with UID 'user123' can delete their income entry under /users/user123/incomes.
     *   Request: { auth: { uid: 'user123' } }
     * @deny (create) - User with UID 'user456' cannot create an income entry under /users/user123/incomes.
     *   Request: { auth: { uid: 'user456' }, resource: { data: { userId: 'user123', amount: 1000, date: '2024-01-15', category: 'Salary' } } }
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/incomes/{incomeId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return resource.data.userId == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && isExistingOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows users to read and write their own expense entries.
     * @path /users/{userId}/expenses
     * @allow (create) - User with UID 'user123' can create an expense entry under /users/user123/expenses.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { userId: 'user123', amount: 50, date: '2024-01-10', category: 'Food' } } }
     * @allow (get) - User with UID 'user123' can read their expense entry under /users/user123/expenses.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (list) - User with UID 'user123' can list their expense entries.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (update) - User with UID 'user123' can update their expense entry under /users/user123/expenses.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { userId: 'user123', amount: 60, date: '2024-01-10', category: 'Food' } } }
     * @allow (delete) - User with UID 'user123' can delete their expense entry under /users/user123/expenses.
     *   Request: { auth: { uid: 'user123' } }
     * @deny (create) - User with UID 'user456' cannot create an expense entry under /users/user123/expenses.
     *   Request: { auth: { uid: 'user456' }, resource: { data: { userId: 'user123', amount: 50, date: '2024-01-10', category: 'Food' } } }
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/expenses/{expenseId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return resource.data.userId == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && isExistingOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows users to read and write their own categories.
     * @path /users/{userId}/categories
     * @allow (create) - User with UID 'user123' can create a category under /users/user123/categories.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { userId: 'user123', name: 'Food', icon: 'utensils', type: 'expense' } } }
     * @allow (get) - User with UID 'user123' can read their category under /users/user123/categories.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (list) - User with UID 'user123' can list their categories.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (update) - User with UID 'user123' can update their category under /users/user123/categories.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { userId: 'user123', name: 'Dining', icon: 'utensils', type: 'expense' } } }
     * @allow (delete) - User with UID 'user123' can delete their category under /users/user123/categories.
     *   Request: { auth: { uid: 'user123' } }
     * @deny (create) - User with UID 'user456' cannot create a category under /users/user123/categories.
     *   Request: { auth: { uid: 'user456' }, resource: { data: { userId: 'user123', name: 'Food', icon: 'utensils', type: 'expense' } } }
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/categories/{categoryId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return resource.data.userId == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && isExistingOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows users to read and write their own budget entries.
     * @path /users/{userId}/budgets
     * @allow (create) - User with UID 'user123' can create a budget entry under /users/user123/budgets.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { userId: 'user123', amount: 200, month: '2024-01' } } }
     * @allow (get) - User with UID 'user123' can read their budget entry under /users/user123/budgets.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (list) - User with UID 'user123' can list their budget entries.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (update) - User with UID 'user123' can update their budget entry under /users/user123/budgets.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { userId: 'user123', amount: 250, month: '2024-01' } } }
     * @allow (delete) - User with UID 'user123' can delete their budget entry under /users/user123/budgets.
     *   Request: { auth: { uid: 'user123' } }
     * @deny (create) - User with UID 'user456' cannot create a budget entry under /users/user123/budgets.
     *   Request: { auth: { uid: 'user456' }, resource: { data: { userId: 'user123', amount: 200, month: '2024-01' } } }
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/budgets/{budgetId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return resource.data.userId == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && isExistingOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows group members to read group info and the creator to write.
     * @path /groups
     * @allow (create) - User with UID 'user123' can create a group.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { name: 'Trip', members: ['user123', 'user456'], createdBy: 'user123', createdAt: '2024-01-01T00:00:00Z' } } }
     * @allow (get) - User with UID 'user123' can read a group if they are a member.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (list) - Signed in users can list the groups.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (update) - User with UID 'user123' can update a group if they created it.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { name: 'Trip to Japan', members: ['user123', 'user456'], createdBy: 'user123', createdAt: '2024-01-01T00:00:00Z' } } }
     * @allow (delete) - User with UID 'user123' can delete a group if they created it.
     *   Request: { auth: { uid: 'user123' } }
     * @deny (create) - User with UID 'user456' cannot create a group with creator 'user123'.
     *   Request: { auth: { uid: 'user456' }, resource: { data: { name: 'Trip', members: ['user123', 'user456'], createdBy: 'user123', createdAt: '2024-01-01T00:00:00Z' } } }
     * @principle Enforces shared access and creator-only writes.
     */
    match /groups/{groupId} {
      function isSignedIn() {
        return request.auth != null;
      }
      
      function isMember(groupId) {
        return request.auth.uid in resource.data.members;
      }

      function isCreator() {
        return request.auth.uid == resource.data.createdBy;
      }

      allow get: if isSignedIn() && isMember(groupId);
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isSignedIn() && isCreator();
      allow delete: if isSignedIn() && isCreator();
    }

    /**
     * @description Allows group members to read and write shared expenses within a group.
     * @path /groups/{groupId}/sharedExpenses
     * @allow (create) - User with UID 'user123' can create a shared expense in group 'group123' if they are a member.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { groupId: 'group123', description: 'Dinner', amount: 50, paidBy: 'user123', date: '2024-01-16', splits: [{ userId: 'user123', amount: 25 }, { userId: 'user456', amount: 25 }] } } }
     * @allow (get) - User with UID 'user123' can read a shared expense if they are a member of the group.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (list) - User with UID 'user123' can list shared expenses if they are a member of the group.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (update) - User with UID 'user123' can update a shared expense in group 'group123' if they are a member.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { groupId: 'group123', description: 'Lunch', amount: 30, paidBy: 'user123', date: '2024-01-16', splits: [{ userId: 'user123', amount: 15 }, { userId: 'user456', amount: 15 }] } } }
     * @allow (delete) - User with UID 'user123' can delete a shared expense in group 'group123' if they are a member.
     *   Request: { auth: { uid: 'user123' } }
     * @deny (create) - User with UID 'user789' cannot create a shared expense in group 'group123' if they are not a member.
     *   Request: { auth: { uid: 'user789' }, resource: { data: { groupId: 'group123', description: 'Dinner', amount: 50, paidBy: 'user123', date: '2024-01-16', splits: [{ userId: 'user123', amount: 25 }, { userId: 'user456', amount: 25 }] } } }
     * @principle Enforces group membership for access.
     */
    match /groups/{groupId}/sharedExpenses/{sharedExpenseId} {
        function isMember(groupId) {
          return request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
        }

        allow get: if isMember(groupId);
        allow list: if isMember(groupId);
        allow create: if isMember(groupId);
        allow update: if isMember(groupId);
        allow delete: if isMember(groupId);
    }

    /**
     * @description Allows involved users to read debt info and creator to write.
     * @path /debts
     * @allow (create) - User with UID 'user123' can create a debt record.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { fromUserId: 'user456', toUserId: 'user123', amount: 25, description: 'Lunch', settled: false, createdBy: 'user123' } } }
     * @allow (get) - User with UID 'user123' can read a debt record if they are fromUser or toUser or creator.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (list) - Signed in users can list the debts.
     *   Request: { auth: { uid: 'user123' } }
     * @allow (update) - User with UID 'user123' can update a debt record if they created it.
     *   Request: { auth: { uid: 'user123' }, resource: { data: { fromUserId: 'user456', toUserId: 'user123', amount: 25, description: 'Lunch', settled: true, createdBy: 'user123' } } }
     * @allow (delete) - User with UID 'user123' can delete a debt record if they created it.
     *   Request: { auth: { uid: 'user123' } }
     * @deny (create) - User with UID 'user456' cannot create a debt record for other users.
     *   Request: { auth: { uid: 'user456' }, resource: { data: { fromUserId: 'user456', toUserId: 'user123', amount: 25, description: 'Lunch', settled: false, createdBy: 'user123' } } }
     * @principle Enforces shared access and creator-only writes.
     */
    match /debts/{debtId} {
      function isSignedIn() {
        return request.auth != null;
      }
      
      function isInvolved() {
        return request.auth.uid == resource.data.fromUserId
            || request.auth.uid == resource.data.toUserId
            || request.auth.uid == resource.data.createdBy;
      }

      function isCreator() {
          return request.auth.uid == resource.data.createdBy;
      }

      allow get: if isInvolved();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isSignedIn() && isCreator();
      allow delete: if isSignedIn() && isCreator();
    }
  }
}