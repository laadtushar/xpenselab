rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects the root of the database from unauthorized access.
     * @path /
     * @allow get, list: if false;
     * @allow create, update, delete: if false;
     * @deny get: Always denies access to the root.
     * @principle Prevents unintended access to the entire database.
     */
    match /{document=**} {
      allow read, write: if false;
    }

    /**
     * @description Allows users to read and write their own user profile data.
     * @path /users/{userId}
     * @allow get: if isSignedIn() && isOwner(userId);
     * @allow list: if false;
     * @allow create: if isSignedIn() && isOwner(userId);
     * @allow update: if isSignedIn() && isOwner(userId);
     * @allow delete: if isDeletableUser(userId);
     * @deny get: if !isSignedIn();
     * @deny create: if !isSignedIn() || request.auth.uid != request.resource.data.id;
     * @deny update: if !isSignedIn();
     * @deny delete: if !isSignedIn();
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isDeletableUser(userId);
    }

    /**
     * @description Allows users to manage their own income entries.
     * @path /users/{userId}/incomes/{incomeId}
     * @allow get: if isSignedIn() && isOwner(userId);
     * @allow list: if isSignedIn() && isOwner(userId);
     * @allow create: if isSignedIn() && isOwner(userId);
     * @allow update: if isSignedIn() && isOwner(userId);
     * @allow delete: if isDeletable(userId);
     * @deny get: if !isSignedIn();
     * @deny create: if !isSignedIn();
     * @deny update: if !isSignedIn();
     * @deny delete: if !isSignedIn();
     * @principle Enforces document ownership for income entries.
     */
    match /users/{userId}/incomes/{incomeId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isDeletable(userId);
    }

    /**
     * @description Allows users to manage their own expense entries.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow get: if isSignedIn() && isOwner(userId);
     * @allow list: if isSignedIn() && isOwner(userId);
     * @allow create: if isSignedIn() && isOwner(userId);
     * @allow update: if isSignedIn() && isOwner(userId);
     * @allow delete: if isDeletable(userId);
     * @deny get: if !isSignedIn();
     * @deny create: if !isSignedIn();
     * @deny update: if !isSignedIn();
     * @deny delete: if !isSignedIn();
     * @principle Enforces document ownership for expense entries.
     */
    match /users/{userId}/expenses/{expenseId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isDeletable(userId);
    }

    /**
     * @description Allows users to manage their own categories.
     * @path /users/{userId}/categories/{categoryId}
     * @allow get: if isSignedIn() && isOwner(userId);
     * @allow list: if isSignedIn() && isOwner(userId);
     * @allow create: if isSignedIn() && isOwner(userId);
     * @allow update: if isSignedIn() && isOwner(userId);
     * @allow delete: if isDeletable(userId);
     * @deny get: if !isSignedIn();
     * @deny create: if !isSignedIn();
     * @deny update: if !isSignedIn();
     * @deny delete: if !isSignedIn();
     * @principle Enforces document ownership for categories.
     */
    match /users/{userId}/categories/{categoryId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isDeletable(userId);
    }

    /**
     * @description Allows users to manage their own budgets.
     * @path /users/{userId}/budgets/{budgetId}
     * @allow get: if isSignedIn() && isOwner(userId);
     * @allow list: if isSignedIn() && isOwner(userId);
     * @allow create: if isSignedIn() && isOwner(userId);
     * @allow update: if isSignedIn() && isOwner(userId);
     * @allow delete: if isDeletable(userId);
     * @deny get: if !isSignedIn();
     * @deny create: if !isSignedIn();
     * @deny update: if !isSignedIn();
     * @deny delete: if !isSignedIn();
     * @principle Enforces document ownership for budget entries.
     */
    match /users/{userId}/budgets/{budgetId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isDeletable(userId);
    }

    /**
     * @description Allows members of a group to access group information.
     * @path /groups/{groupId}
     * @allow get: if isSignedIn() && isGroupMember(groupId);
     * @allow list: if false;
     * @allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
     * @allow update: if isSignedIn() && isGroupAdmin(groupId);
     * @allow delete: if isDeletableGroup(groupId);
     * @deny get: if !isSignedIn();
     * @deny create: if !isSignedIn();
     * @deny update: if !isSignedIn();
     * @deny delete: if !isSignedIn();
     * @principle Enforces group membership for access to group data.
     */
    match /groups/{groupId} {
      allow get: if isSignedIn() && isGroupMember(groupId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.createdBy;
      allow update: if isSignedIn() && isGroupAdmin(groupId);
      allow delete: if isDeletableGroup(groupId);
    }

    /**
     * @description Allows members of a group to manage shared expenses.
     * @path /groups/{groupId}/sharedExpenses/{sharedExpenseId}
     * @allow get: if isSignedIn() && isGroupMember(groupId);
     * @allow list: if isSignedIn() && isGroupMember(groupId);
     * @allow create: if isSignedIn() && isGroupMember(groupId) && request.resource.data.groupId == groupId;
     * @allow update: if isSignedIn() && isGroupAdmin(groupId) && request.resource.data.groupId == groupId;
     * @allow delete: if isSignedIn() && isGroupAdmin(groupId) && request.resource.data.groupId == groupId;
     * @deny get: if !isSignedIn();
     * @deny create: if !isSignedIn();
     * @deny update: if !isSignedIn();
     * @deny delete: if !isSignedIn();
     * @principle Enforces group membership for access to shared expenses.
     */
    match /groups/{groupId}/sharedExpenses/{sharedExpenseId} {
      allow get: if isSignedIn() && isGroupMember(groupId);
      allow list: if isSignedIn() && isGroupMember(groupId);
      allow create: if isSignedIn() && isGroupMember(groupId) && request.resource.data.groupId == groupId;
      allow update: if isSignedIn() && isGroupAdmin(groupId) && request.resource.data.groupId == groupId;
      allow delete: if isSignedIn() && isGroupAdmin(groupId) && request.resource.data.groupId == groupId;
    }

    /**
     * @description Allows involved users to access debt information.
     * @path /debts/{debtId}
     * @allow get: if isSignedIn() && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
     * @allow list: if false;
     * @allow create: if isSignedIn() && (request.resource.data.fromUserId == request.auth.uid || request.resource.data.toUserId == request.auth.uid);
     * @allow update: if isSignedIn() && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
     * @allow delete: if isDeletableDebt();
     * @deny get: if !isSignedIn();
     * @deny create: if !isSignedIn();
     * @deny update: if !isSignedIn();
     * @deny delete: if !isSignedIn();
     * @principle Enforces that only the involved users can access debt information.
     */
    match /debts/{debtId} {
      allow get: if isSignedIn() && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
      allow list: if false;
      allow create: if isSignedIn() && (request.resource.data.fromUserId == request.auth.uid || request.resource.data.toUserId == request.auth.uid);
      allow update: if isSignedIn() && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
      allow delete: if isDeletableDebt();
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return request.auth.uid == resource.data.userId;
    }

    function isGroupMember(groupId) {
       return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
    }

    function isGroupAdmin(groupId) {
      return isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid;
    }

    function isExistingGroup(groupId) {
      return exists(/databases/$(database)/documents/groups/$(groupId));
    }

    function isExistingDebt() {
      return exists(/databases/$(database)/documents/debts/$(debtId));
    }

    function isDeletable(userId) {
        return isSignedIn() && isOwner(userId);
    }

    function isDeletableGroup(groupId) {
        return isSignedIn() && isGroupAdmin(groupId);
    }

    function isDeletableDebt() {
        return isSignedIn() && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
    }

    function isDeletableUser(userId) {
        return isSignedIn() && isOwner(userId);
    }
  }
}