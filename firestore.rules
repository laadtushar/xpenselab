rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data. Only the user can read or write their own profile.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile if request.auth.uid == 'user123'.
     * @allow (get) User with ID 'user123' can read their profile.
     * @allow (update) User with ID 'user123' can update their profile.
     * @allow (delete) User with ID 'user123' can delete their profile.
     * @deny (create) User with ID 'user456' cannot create a profile with ID 'user123'.
     * @principle Enforces user-ownership of profile data, validates ownership on creation, and prevents unauthorized profile manipulation.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to income entries for a specific user. Only the owner can read or write.
     * @path /users/{userId}/incomes/{incomeId}
     * @allow (create) User with ID 'user123' can create an income entry under their profile.
     * @allow (get) User with ID 'user123' can read an income entry under their profile.
     * @allow (update) User with ID 'user123' can update an income entry under their profile.
     * @allow (delete) User with ID 'user123' can delete an income entry under their profile.
     * @deny (create) User with ID 'user456' cannot create an income entry under user 'user123''s profile.
     * @principle Enforces user-ownership of income data.
     */
    match /users/{userId}/incomes/{incomeId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to expense entries for a specific user. Only the owner can read or write.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (create) User with ID 'user123' can create an expense entry under their profile.
     * @allow (get) User with ID 'user123' can read an expense entry under their profile.
     * @allow (update) User with ID 'user123' can update an expense entry under their profile.
     * @allow (delete) User with ID 'user123' can delete an expense entry under their profile.
     * @deny (create) User with ID 'user456' cannot create an expense entry under user 'user123''s profile.
     * @principle Enforces user-ownership of expense data.
     */
    match /users/{userId}/expenses/{expenseId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to category entries for a specific user. Only the owner can read or write.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create) User with ID 'user123' can create a category entry under their profile.
     * @allow (get) User with ID 'user123' can read a category entry under their profile.
     * @allow (update) User with ID 'user123' can update a category entry under their profile.
     * @allow (delete) User with ID 'user123' can delete a category entry under their profile.
     * @deny (create) User with ID 'user456' cannot create a category entry under user 'user123''s profile.
     * @principle Enforces user-ownership of category data.
     */
    match /users/{userId}/categories/{categoryId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to budget entries for a specific user. Only the owner can read or write.
     * @path /users/{userId}/budgets/{budgetId}
     * @allow (create) User with ID 'user123' can create a budget entry under their profile.
     * @allow (get) User with ID 'user123' can read a budget entry under their profile.
     * @allow (update) User with ID 'user123' can update a budget entry under their profile.
     * @allow (delete) User with ID 'user123' can delete a budget entry under their profile.
     * @deny (create) User with ID 'user456' cannot create a budget entry under user 'user123''s profile.
     * @principle Enforces user-ownership of budget data.
     */
    match /users/{userId}/budgets/{budgetId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to group data. Access is granted to group members.
     * @path /groups/{groupId}
     * @allow (create) User with ID 'user123' can create a group.
     * @allow (get) User with ID 'user123' can read a group if they are a member.
     * @allow (update) User with ID 'user123' can update a group if they are a member.
     * @allow (delete) User with ID 'user123' can delete a group if they are the creator.
     * @deny (create) User with ID 'user456' cannot create a group if they are not authenticated.
     * @principle Enforces shared access based on group membership, and restricts group deletion to the creator.
     */
    match /groups/{groupId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMember() {
        return isSignedIn() && request.auth.uid in resource.data.members;
      }
      function isCreator() {
        return isSignedIn() && request.auth.uid == resource.data.createdBy;
      }

      allow get: if isMember();
      allow list: if false;

      allow create: if isSignedIn() && request.auth.uid == request.resource.data.createdBy;
      allow update: if isMember();
      allow delete: if isCreator();
    }

    /**
     * @description Controls access to shared expense data within a group. Access is granted to group members.
     * @path /groups/{groupId}/sharedExpenses/{sharedExpenseId}
     * @allow (create) User with ID 'user123' can create a shared expense if they are a member of the group.
     * @allow (get) User with ID 'user123' can read a shared expense if they are a member of the group.
     * @allow (update) User with ID 'user123' can update a shared expense if they are a member of the group.
     * @allow (delete) User with ID 'user123' can delete a shared expense if they are a member of the group.
     * @deny (create) User with ID 'user456' cannot create a shared expense if they are not a member of the group.
     * @principle Enforces shared access based on group membership for shared expenses.
     */
    match /groups/{groupId}/sharedExpenses/{sharedExpenseId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMember() {
          return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
      }

      allow get: if isMember();
      allow list: if false;

      allow create: if isMember();
      allow update: if isMember();
      allow delete: if isMember();
    }

    /**
     * @description Controls access to debt data. Only the involved users can read, and only the creator can update.
     * @path /debts/{debtId}
     * @allow (create) User can create a debt if their ID is either 'fromUserId' or 'toUserId'.
     * @allow (get) User can get a debt if their ID is either 'fromUserId' or 'toUserId'.
     * @allow (update) Only the creator can update a debt record, besides `fromUserId` or `toUserId`.
     * @allow (delete) Only the creator can delete a debt record.
     * @deny (create) User cannot create a debt if their ID is not 'fromUserId' or 'toUserId'.
     * @principle Enforces access based on involvement in the debt, and creator-based updates.
     */
    match /debts/{debtId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isInvolved() {
        return isSignedIn() && (request.auth.uid == resource.data.fromUserId || request.auth.uid == resource.data.toUserId);
      }
      function isCreator() {
          return isSignedIn() && resource.data.createdBy == request.auth.uid;
      }
      function isExistingInvolved() {
        return isInvolved() && exists(resource);
      }
      function isExistingCreator() {
        return isCreator() && exists(resource);
      }
      allow get: if isInvolved();
      allow list: if false;

      allow create: if isSignedIn() && (request.resource.data.fromUserId == request.auth.uid || request.resource.data.toUserId == request.auth.uid) && request.auth.uid == request.resource.data.createdBy;
      allow update: if isCreator();
      allow delete: if isCreator();
    }
  }
}