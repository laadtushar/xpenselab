/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for personal finance data, 
 * allowing users to manage their own incomes, expenses, categories, and budgets. Groups and 
 * shared expenses enable collaborative financial management. Debts are tracked between users.
 * 
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only to the user themselves.
 * - /users/{userId}/incomes/{incomeId}: Income entries, accessible only to the owning user.
 * - /users/{userId}/expenses/{expenseId}: Expense entries, accessible only to the owning user.
 * - /users/{userId}/categories/{categoryId}: User-defined categories, accessible only to the owning user.
 * - /users/{userId}/budgets/{budgetId}: Budget entries, accessible only to the owning user.
 * - /groups/{groupId}: Group information, accessible to group members.
 * - /groups/{groupId}/sharedExpenses/{sharedExpenseId}: Shared expenses within a group, accessible to group members.
 * - /debts/{debtId}: Debt information between users, create-able by either the user who owns money, or the user who is owed money.
 * 
 * Key Security Decisions:
 * - Users can only read and write their own data under their respective /users/{userId} path.
 * - Listing of users is explicitly denied to protect user privacy.
 * - Groups and shared expenses utilize a shared access model, where membership is determined by the 'members' array.
 * - The `createdBy` field in the Debt document is used to establish the creator of the debt, allowing debts to be created by either party.
 * - In cases where relationships are ambiguous (e.g. with Debts), the rules default to the most secure posture.
 * 
 * Denormalization for Authorization:
 * - Group documents contain a `members` array to simplify access control for shared expenses.
 * - Debt documents use a `createdBy` field for simpler ownership tracking.
 * 
 * Structural Segregation:
 * - User-specific data (incomes, expenses, budgets, categories) is stored in user subcollections to maintain privacy and enforce ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces access control for user profiles. Only the authenticated user can read/write their own profile.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' can create their own profile at /users/cZtUAUbAFmStzY4csAAJXmY6JAn1.
     * @deny (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' cannot access or modify the profile of another user /users/anotherUserId.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing users is not permitted

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Enforces access control for income entries. Only the authenticated user can read/write their own income entries.
     * @path /databases/{database}/documents/users/{userId}/incomes/{incomeId}
     * @allow (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' can create an income entry under their profile.
     * @deny (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' cannot access or modify the income entries of another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/incomes/{incomeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Enforces access control for expense entries. Only the authenticated user can read/write their own expense entries.
     * @path /databases/{database}/documents/users/{userId}/expenses/{expenseId}
     * @allow (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' can create an expense entry under their profile.
     * @deny (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' cannot access or modify the expense entries of another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/expenses/{expenseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Enforces access control for category entries. Only the authenticated user can read/write their own category entries.
     * @path /databases/{database}/documents/users/{userId}/categories/{categoryId}
     * @allow (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' can create a category entry under their profile.
     * @deny (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' cannot access or modify the category entries of another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/categories/{categoryId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Enforces access control for budget entries. Only the authenticated user can read/write their own budget entries.
     * @path /databases/{database}/documents/users/{userId}/budgets/{budgetId}
     * @allow (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' can create a budget entry under their profile.
     * @deny (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' cannot access or modify the budget entries of another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/budgets/{budgetId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Enforces access control for group documents. Only members of the group can read/write group information.
     * @path /databases/{database}/documents/groups/{groupId}
     * @allow (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' (if a member) can create a group.
     * @deny (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' (if not a member) cannot access or modify the group.
     * @principle Enforces shared access based on group membership.
     */
    match /groups/{groupId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isMember() {
          return isSignedIn() && request.auth.uid in resource.data.members;
      }

      function isGroupCreator() {
        return isSignedIn() && request.auth.uid == resource.data.createdBy;
      }

      allow get: if isSignedIn() && isMember();
      allow list: if false;

      allow create: if isSignedIn() && request.resource.data.members.hasOnly([request.auth.uid]) && request.resource.data.createdBy == request.auth.uid;
      allow update: if isSignedIn() && isMember();
      allow delete: if isSignedIn() && isGroupCreator();
    }

    /**
     * @description Enforces access control for shared expense documents. Only members of the parent group can read/write shared expenses.
     * @path /databases/{database}/documents/groups/{groupId}/sharedExpenses/{sharedExpenseId}
     * @allow (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' (if a member of the parent group) can create a shared expense.
     * @deny (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' (if not a member of the parent group) cannot access or modify the shared expense.
     * @principle Enforces shared access based on group membership.
     */
    match /groups/{groupId}/sharedExpenses/{sharedExpenseId} {
       function isSignedIn() {
        return request.auth != null;
      }

      function isMember(groupId) {
          return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
      }
       
      allow get: if isSignedIn() && isMember(groupId);
      allow list: if false;
      allow create: if isSignedIn() && isMember(groupId);
      allow update: if isSignedIn() && isMember(groupId);
      allow delete: if isSignedIn() && isMember(groupId);
    }

    /**
     * @description Enforces access control for debt documents.  Either user involved can read, create, update, or delete the debt.
     * @path /databases/{database}/documents/debts/{debtId}
     * @allow (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' can create a debt with themself or another user.
     * @deny (create, get, update, delete) User 'cZtUAUbAFmStzY4csAAJXmY6JAn1' cannot modify a debt they are not a part of.
     */
    match /debts/{debtId} {
       function isSignedIn() {
        return request.auth != null;
      }

      function isInvolved() {
        return isSignedIn() && (request.auth.uid == resource.data.fromUserId || request.auth.uid == resource.data.toUserId);
      }

      allow get: if isSignedIn() && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
      allow list: if false;
      allow create: if isSignedIn() && (request.resource.data.fromUserId == request.auth.uid || request.resource.data.toUserId == request.auth.uid);
      allow update: if isSignedIn() && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
      allow delete: if isSignedIn() && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
    }
  }
}