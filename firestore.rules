
/**
 * @fileOverview Firestore Security Rules for FinanceFlow.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal financial data
 * (incomes, expenses, budgets, categories), ensuring that only the authenticated
 * user can create, read, update, or delete their own data. Shared financial data
 * (groups, shared expenses, debts) uses a shared access model, where group members
 * can access group-related data.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.
 * - /users/{userId}/incomes/{incomeId}: Stores income entries for a specific user.
 * - /users/{userId}/expenses/{expenseId}: Stores expense entries for a specific user.
 * - /users/{userId}/categories/{categoryId}: Stores categories for a specific user.
 * - /users/{userId}/budgets/{budgetId}: Stores budget entries for a specific user.
 * - /users/{userId}/recurringTransactions/{recurringTransactionId}: Stores recurring transactions.
 * - /users/{userId}/financialInsights/{insightId}: Stores AI-generated insights.
 * - /users/{userId}/loans/{loanId}: Stores structured loans for a user.
 * - /users/{userId}/loans/{loanId}/repayments/{repaymentId}: Stores repayments for a loan.
 * - /groups/{groupId}: Stores group information for shared expenses.
 * - /groups/{groupId}/sharedExpenses/{expenseId}: Stores individual shared expenses.
 * - /debts/{debtId}: Stores debt information between users.
 *
 * Key Security Decisions:
 * - Users can only access their own profile data.
 * - Users can only access income, expense, category, budget, and loan data associated with their user ID.
 * - Groups and shared expenses are accessible to group members.
 * - Debts are accessible to participants.
 * - Data validation is relaxed in this prototype phase, focusing on authorization.
 *
 * Denormalization for Authorization:
 * - Incomes, expenses, categories and budgets documents all require the `userId` field for
 *   authorization.
 * - SharedExpenses documents require `groupId` and the `splits` array to determine authorized users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) - User with matching {userId} can create their profile.
     * @allow (get, update, delete) - User with matching {userId} can read, update, and delete their profile.
     * @deny (create) - User cannot create a profile with a different {userId}.
     * @deny (get, update, delete) - User cannot read, update, or delete another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow read, update, delete, create: if request.auth.uid == userId;
    }

    /**
     * @description Controls access to income entries for a specific user.
     * @path /users/{userId}/incomes/{incomeId}
     * @allow (create) - User with matching {userId} can create income entries.
     * @allow (get, list, update, delete) - User with matching {userId} can read, list, update, and delete their own income entries.
     * @deny (create) - User cannot create income entries for another user.
     * @deny (get, list, update, delete) - User cannot read, list, update, or delete another user's income entries.
     * @principle Enforces document ownership for income entries.
     */
    match /users/{userId}/incomes/{incomeId} {
      allow read, write: if request.auth.uid == userId;
    }
    
    match /users/{userId}/incomes {
      allow list: if request.auth.uid == userId;
    }

    /**
     * @description Controls access to expense entries for a specific user.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (create) - User with matching {userId} can create expense entries.
     * @allow (get, list, update, delete) - User with matching {userId} can read, list, update, and delete their own expense entries.
     * @deny (create) - User cannot create expense entries for another user.
     * @deny (get, list, update, or delete) - User cannot read, list, update, or delete another user's expense entries.
     * @principle Enforces document ownership for expense entries.
     */
    match /users/{userId}/expenses/{expenseId} {
      allow read, write: if request.auth.uid == userId;
    }

    match /users/{userId}/expenses {
      allow list: if request.auth.uid == userId;
    }

    /**
     * @description Controls access to category entries for a specific user.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create) - User with matching {userId} can create category entries.
     * @allow (get, list, update, delete) - User with matching {userId} can read, list, update, and delete their own category entries.
     * @deny (create) - User cannot create category entries for another user.
     * @deny (get, list, update, or delete) - User cannot read, list, update, or delete another user's category entries.
     * @principle Enforces document ownership for category entries.
     */
    match /users/{userId}/categories/{categoryId} {
      allow read, write: if request.auth.uid == userId;
    }

    match /users/{userId}/categories {
      allow list: if request.auth.uid == userId;
    }
    
    /**
     * @description Controls access to recurring transactions for a specific user.
     */
    match /users/{userId}/recurringTransactions/{recurringTransactionId} {
      allow read, write: if request.auth.uid == userId;
    }

    match /users/{userId}/recurringTransactions {
      allow list: if request.auth.uid == userId;
    }

    /**
     * @description Controls access to financial insights for a specific user.
     */
    match /users/{userId}/financialInsights/{insightId} {
      allow read, create, delete: if request.auth.uid == userId;
      allow update: if false;
    }

    match /users/{userId}/financialInsights {
      allow list: if request.auth.uid == userId;
    }

    /**
     * @description Controls access to loan and repayment entries for a specific user.
     */
    match /users/{userId}/loans/{loanId} {
      allow read, write: if request.auth.uid == userId;

      match /repayments/{repaymentId} {
        allow read, write: if request.auth.uid == userId;
      }

      match /repayments {
        allow list: if request.auth.uid == userId;
      }
    }

    match /users/{userId}/loans {
      allow list: if request.auth.uid == userId;
    }


    /**
     * @description Controls access to budget entries for a specific user.
     * @path /users/{userId}/budgets/{budgetId}
     * @allow (create) - User with matching {userId} can create budget entries.
     * @allow (get, list, update, delete) - User with matching {userId} can read, list, update, and delete their own budget entries.
     * @deny (create) - User cannot create budget entries for another user.
     * @deny (get, list, update, or delete) - User cannot read, list, update, or delete another user's budget entries.
     * @principle Enforces document ownership for budget entries.
     */
    match /users/{userId}/budgets/{budgetId} {
      allow read, write: if request.auth.uid == userId;
    }

    match /users/{userId}/budgets {
      allow list: if request.auth.uid == userId;
    }

    /**
     * @description Controls access to group documents.
     * @path /groups/{groupId}
     * @allow (create) - Any authenticated user can create a group.
     * @allow (get, list) - Any authenticated user can read and list groups.
     * @allow (update) - Only members of the group can update it.
     * @allow (delete) - Only the group creator can delete the group.
     * @principle Enforces group membership for access to group details.
     */
    match /groups/{groupId} {
        allow get: if isGroupMember(groupId);
        allow create: if isSignedIn();
        allow update: if isSignedIn() && request.auth.uid in resource.data.members;
        allow delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
    }

    match /groups {
        allow list: if isSignedIn();
    }

    /**
     * @description Controls access to shared expense documents within a group.
     * @path /groups/{groupId}/sharedExpenses/{expenseId}
     * @allow (create) - Only group members can create shared expenses.
     * @allow (get, list) - Only group members can read and list shared expenses.
     * @allow (update, delete) - Only the user who created the expense can update or delete it.
     * @principle Enforces group membership for access to shared expenses.
     */
    match /groups/{groupId}/sharedExpenses/{expenseId} {
        allow get: if isGroupMember(groupId);
        allow create: if isGroupMember(groupId) && request.resource.data.groupId == groupId;
        allow update: if isGroupMember(groupId) && resource.data.paidBy == request.auth.uid;
        allow delete: if isGroupMember(groupId) && resource.data.paidBy == request.auth.uid;
    }

    match /groups/{groupId}/sharedExpenses {
        allow list: if isGroupMember(groupId);
    }


    /**
     * @description Controls access to debt documents.
     * @path /debts/{debtId}
     * @allow (get, list) - Any authenticated user can read debts.
     * @allow (create) - Any authenticated user can create a debt.
     * @allow (update) - Only the creator of the debt can update it.
     * @allow (delete) - Only the creator of the debt can delete it.
     */
    match /debts/{debtId} {
        allow get: if isSignedIn() && (request.auth.uid == resource.data.fromUserId || request.auth.uid == resource.data.toUserId || request.auth.uid == resource.data.createdBy);
        allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
        allow update: if isSignedIn() && resource.data.createdBy == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
    }

    match /debts {
        allow list: if isSignedIn();
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isGroupMember(groupId) {
        return request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
    }
  }
}
