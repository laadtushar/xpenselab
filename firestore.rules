/**
 * @fileoverview Firestore Security Rules for FinanceFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal financial data
 * and a shared-access model for group-related data. It prioritizes secure access
 * and maintainability over complex data validation, allowing for rapid prototyping.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only by the user themselves.
 * - /users/{userId}/incomes/{incomeId}: Income entries owned by the user.
 * - /users/{userId}/expenses/{expenseId}: Expense entries owned by the user.
 * - /users/{userId}/categories/{categoryId}: Categories owned by the user.
 * - /users/{userId}/budgets/{budgetId}: Budgets owned by the user.
 * - /groups/{groupId}: Groups with shared expenses, accessible to group members.
 * - /groups/{groupId}/sharedExpenses/{sharedExpenseId}: Shared expenses within a group, accessible to group members.
 * - /debts/{debtId}: Debts between users, accessible to the involved users.
 *
 * Key Security Decisions:
 * - User data is strictly controlled by the authenticated user ID.
 * - Group data requires membership verification.
 * - Data validation is minimal, focusing on authorization-critical fields.
 * - List operations are secured to prevent unauthorized data access.
 *
 * Denormalization for Authorization:
 * - Group documents contain a `members` array to avoid `get()` calls for membership checks.
 * - SharedExpense documents are nested under Group documents to simplify access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource based on the userId.
     * @param {string} userId - The user ID to compare with the authenticated user's ID.
     * @return {bool} True if the user is the owner, false otherwise.
     * @example isOwner('user123') will return true if request.auth.uid is 'user123'.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource and the resource exists.
     * @param {string} userId - The user ID to compare with the authenticated user's ID.
     * @return {bool} True if the user is the owner and the resource exists, false otherwise.
     * @example isExistingOwner('user123') will return true if request.auth.uid is 'user123' and the resource exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource.data != null;
    }

    /**
     * @description Checks if the authenticated user is a member of the group.
     * @param {array} members - Array of user IDs who are members of the group.
     * @return {bool} True if the user is a member, false otherwise.
     */
    function isGroupMember(members) {
        return isSignedIn() && members is list && members.hasAny([request.auth.uid]);
    }

    /**
     * @description Checks if the authenticated user can update the member list
     * @param {map} members - Map of user IDs to roles of members of the group.
     * @return {bool} True if the user is an owner, false otherwise.
     */
    function canManageGroupMembers(members) {
        return isSignedIn() && members[request.auth.uid] == 'owner';
    }

    /**
     * @description Defines access rules for user profiles.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) User 'user123' can create their profile if request.auth.uid is 'user123'.
     * @deny (create) User 'user456' cannot create profile for 'user123'.
     * @allow (get) User 'user123' can read their profile if request.auth.uid is 'user123'.
     * @deny (get) User 'user456' cannot read profile of 'user123'.
     * @allow (update) User 'user123' can update their profile if request.auth.uid is 'user123'.
     * @deny (update) User 'user456' cannot update profile of 'user123'.
     * @allow (delete) User 'user123' can delete their profile if request.auth.uid is 'user123'.
     * @deny (delete) User 'user456' cannot delete profile of 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if false;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Defines access rules for income entries under a user's profile.
     * @path /databases/{database}/documents/users/{userId}/incomes/{incomeId}
     * @allow (create) User 'user123' can create an income entry under their profile.
     * @deny (create) User 'user456' cannot create an income entry under 'user123' profile.
     * @allow (get) User 'user123' can read an income entry under their profile.
     * @deny (get) User 'user456' cannot read income entry under 'user123' profile.
     * @allow (update) User 'user123' can update an income entry under their profile.
     * @deny (update) User 'user456' cannot update income entry under 'user123' profile.
     * @allow (delete) User 'user123' can delete an income entry under their profile.
     * @deny (delete) User 'user456' cannot delete income entry under 'user123' profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/incomes/{incomeId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if false;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Defines access rules for expense entries under a user's profile.
     * @path /databases/{database}/documents/users/{userId}/expenses/{expenseId}
     * @allow (create) User 'user123' can create an expense entry under their profile.
     * @deny (create) User 'user456' cannot create an expense entry under 'user123' profile.
     * @allow (get) User 'user123' can read an expense entry under their profile.
     * @deny (get) User 'user456' cannot read expense entry under 'user123' profile.
     * @allow (update) User 'user123' can update an expense entry under their profile.
     * @deny (update) User 'user456' cannot update expense entry under 'user123' profile.
     * @allow (delete) User 'user123' can delete an expense entry under their profile.
     * @deny (delete) User 'user456' cannot delete expense entry under 'user123' profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/expenses/{expenseId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if false;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Defines access rules for category entries under a user's profile.
     * @path /databases/{database}/documents/users/{userId}/categories/{categoryId}
     * @allow (create) User 'user123' can create a category entry under their profile.
     * @deny (create) User 'user456' cannot create a category entry under 'user123' profile.
     * @allow (get) User 'user123' can read a category entry under their profile.
     * @deny (get) User 'user456' cannot read category entry under 'user123' profile.
     * @allow (update) User 'user123' can update a category entry under their profile.
     * @deny (update) User 'user456' cannot update category entry under 'user123' profile.
     * @allow (delete) User 'user123' can delete a category entry under their profile.
     * @deny (delete) User 'user456' cannot delete category entry under 'user123' profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/categories/{categoryId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if false;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Defines access rules for budget entries under a user's profile.
     * @path /databases/{database}/documents/users/{userId}/budgets/{budgetId}
     * @allow (create) User 'user123' can create a budget entry under their profile.
     * @deny (create) User 'user456' cannot create a budget entry under 'user123' profile.
     * @allow (get) User 'user123' can read a budget entry under their profile.
     * @deny (get) User 'user456' cannot read budget entry under 'user123' profile.
     * @allow (update) User 'user123' can update a budget entry under their profile.
     * @deny (update) User 'user456' cannot update budget entry under 'user123' profile.
     * @allow (delete) User 'user123' can delete a budget entry under their profile.
     * @deny (delete) User 'user456' cannot delete budget entry under 'user123' profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/budgets/{budgetId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if false;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Defines access rules for groups.
     * @path /databases/{database}/documents/groups/{groupId}
     * @allow (create) User 'user123' can create a group if they are signed in.
     * @deny (create) Anonymous user cannot create a group.
     * @allow (get) User 'user123' can read a group if they are a member.
     * @deny (get) User 'user456' cannot read a group if they are not a member.
     * @allow (update) User 'user123' can update a group if they are a member and have sufficient permissions.
     * @deny (update) User 'user456' cannot update a group if they are not a member.
     * @allow (delete) User 'user123' can delete a group if they are a member and have sufficient permissions.
     * @deny (delete) User 'user456' cannot delete a group if they are not a member.
     * @principle Enforces shared access among group members.
     */
    match /groups/{groupId} {
        allow create: if isSignedIn();
        allow get: if isGroupMember(resource.data.members);
        allow list: if false;
        allow update: if isGroupMember(resource.data.members);
        allow delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
    }

    /**
     * @description Defines access rules for shared expenses within a group.
     * @path /databases/{database}/documents/groups/{groupId}/sharedExpenses/{sharedExpenseId}
     * @allow (create) User 'user123' can create a shared expense within a group if they are a member.
     * @deny (create) User 'user456' cannot create a shared expense if they are not a member of the group.
     * @allow (get) User 'user123' can read a shared expense if they are a member of the group.
     * @deny (get) User 'user456' cannot read a shared expense if they are not a member of the group.
     * @allow (update) User 'user123' can update a shared expense if they are a member of the group and has write access.
     * @deny (update) User 'user456' cannot update a shared expense if they are not a member of the group.
     * @allow (delete) User 'user123' can delete a shared expense if they are a member of the group and has write access.
     * @deny (delete) User 'user456' cannot delete a shared expense if they are not a member of the group.
     * @principle Enforces shared access among group members for shared expenses.
     */
    match /groups/{groupId}/sharedExpenses/{sharedExpenseId} {
        allow create: if isGroupMember(get(/databases/$(database)/documents/groups/$(groupId)).data.members);
        allow get: if isGroupMember(get(/databases/$(database)/documents/groups/$(groupId)).data.members);
        allow list: if false;
        allow update: if isGroupMember(get(/databases/$(database)/documents/groups/$(groupId)).data.members);
        allow delete: if isGroupMember(get(/databases/$(database)/documents/groups/$(groupId)).data.members);
    }

    /**
     * @description Defines access rules for debts between users.
     * @path /databases/{database}/documents/debts/{debtId}
     * @allow (create) User 'user123' can create a debt if they are involved in the debt.
     * @deny (create) User 'user456' cannot create a debt if they are not involved.
     * @allow (get) User 'user123' can read a debt if they are involved.
     * @deny (get) User 'user456' cannot read a debt if they are not involved.
     * @allow (update) User 'user123' can update a debt if they are involved and has write access.
     * @deny (update) User 'user456' cannot update a debt if they are not involved.
     * @allow (delete) User 'user123' can delete a debt if they are involved and has write access.
     * @deny (delete) User 'user456' cannot delete a debt if they are not involved.
     * @principle Enforces access only to the users involved in the debt.
     */
    match /debts/{debtId} {
        allow create: if isSignedIn() && (request.resource.data.fromUserId == request.auth.uid || request.resource.data.toUserId == request.auth.uid);
        allow get: if isSignedIn() && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
        allow list: if false;
        allow update: if isSignedIn() && (request.resource.data.fromUserId == request.auth.uid || request.resource.data.toUserId == request.auth.uid);
        allow delete: if isSignedIn() && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
    }
  }
}